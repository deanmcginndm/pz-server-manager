version: '3'

services:
  db:
    image: mysql
    container_name: pz-web-db
    restart: always
    volumes:
      - 'mysql_data_dir:/var/lib/mysql'
      #- './docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d'
    expose:
      - '3306'
      #ports:
      #- '3367:3306'
      #- '3329:3306'
    environment:
      MYSQL_DATABASE: 'acn'
      MYSQL_ROOT_PASSWORD: 'acn'
      MYSQL_USER: 'django'
      MYSQL_PASSWORD: 'django'
    command: ['--character-set-server=utf8mb4', '--collation-server=utf8mb4_unicode_ci']
    #command: mysqld --character-set-server=utf8 --collation-server=utf8_unicode_ci --init-connect='SET NAMES UTF8;' --innodb-flush-log-at-trx-commit=0


  web-pz:
    build: .
    container_name: bridges-web
    ports:
      - "8002:8000"
    volumes:
      - ./:/opt/pz-web
      - ./docker-entrypoint.sh:/docker-entrypoint.sh
      - ./wait-for-it.sh:/wait-for-it.sh
    environment:
      PYTHONPATH: "/opt/pz"
      DJANGO_SETTIONGS_MODULE: "project_zomboid_manager.settings"
    command: /wait-for-it.sh db:3306 -t 5 -- /docker-entrypoint.sh
    links:
      - "db:database"
    depends_on:
      - "db"
      #environment:
      #LC_ALL: 'en_US.UTF-8'
      #LANG: 'en_US.UTF-8'
      #LANGUAGE: 'en_US.UTF-8'
    stdin_open: true
    tty: true
  pz:
    container_name: 'pz'
    image: afey/zomboid
    restart: unless-stopped
    tty: true
    stdin_open: true
    depends_on:
      - 'db'
      - 'web-pz'
    env_file:
      - vars.env
    environment:
      SERVER_PORT: 16261
      SERVER_PASSWORD: ""
      SERVER_PUBLIC_NAME: "Anthesis Gaming - Private Project Zomboid Server"
      SERVER_PUBLIC_DESC: "The same old Project Zomboid, customised to our liking, deployed by yours truly"
    ports:
      - "27433:8766/udp"
      - "27434:8767/udp"
      - "16261:16261/udp"
      - "16262-16272:16262-16272"
      - "27431:27015"
    volumes:
      - ./pz_server_manager:/pz_server_manager